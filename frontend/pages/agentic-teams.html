<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../assets/img/favicon.png">
  <title>AI Bank Teams - Virtual Collaboration Dashboard</title>
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700" />
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link id="pagestyle" href="../assets/css/material-dashboard.css?v=3.0.0" rel="stylesheet" />
  <link href="../assets/css/professional-theme.css" rel="stylesheet" />

  <style>

    .dashboard-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
      height: calc(100vh - 180px);
    }

    /* Email Queue Panel */
    .email-queue {
      background: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: 0 20px 27px 0 rgba(0,0,0,0.05);
      overflow-y: auto;
    }

    .email-queue-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .email-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }

    .email-card:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .email-card.active {
      border-left-color: #e91e63;
      background: #f8f9fa;
    }

    .email-card.processing {
      border-left-color: #4caf50;
      background: #f8f9fa;
    }

    .email-card.completed {
      border-left-color: #9e9e9e;
      opacity: 0.7;
    }

    .email-subject {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      color: #333;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .email-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .team-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }

    .team-fraud { background: #ffebee; color: #c62828; }
    .team-compliance { background: #f3e5f5; color: #7b1fa2; }
    .team-investments { background: #e8f5e9; color: #2e7d32; }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .status-pending { background: #9e9e9e; }
    .status-processing {
      background: #4caf50;
      animation: pulse 1.5s ease-in-out infinite;
    }
    .status-completed { background: #2196f3; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Team Discussion Panel */
    .discussion-panel {
      background: white;
      border-radius: 0.75rem;
      padding: 0;
      box-shadow: 0 20px 27px 0 rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .discussion-header {
      background: linear-gradient(195deg, #42424a 0%, #191919 100%);
      color: white;
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .discussion-title {
      font-size: 18px;
      font-weight: 600;
    }

    .discussion-subtitle {
      font-size: 13px;
      opacity: 0.9;
      margin-top: 5px;
    }

    .progress-bar {
      background: rgba(255,255,255,0.3);
      height: 6px;
      border-radius: 3px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-fill {
      background: white;
      height: 100%;
      transition: width 0.5s ease;
    }

    /* Chat Messages */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
    }

    /* Investment Progress Tracker */
    .investment-progress-tracker {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .progress-tracker-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .progress-steps {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .progress-step {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .progress-step.pending {
      opacity: 0.5;
    }

    .progress-step.active {
      background: linear-gradient(195deg, #e3f2fd 0%, #bbdefb 100%);
      border-color: #2196f3;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
    }

    .progress-step.completed {
      background: linear-gradient(195deg, #e8f5e9 0%, #c8e6c9 100%);
      border-color: #4caf50;
    }

    .step-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .step-label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 4px;
    }

    .step-status {
      font-size: 11px;
      color: #999;
    }

    .progress-step.active .step-status {
      color: #2196f3;
      font-weight: 600;
      animation: pulse-text 1.5s ease-in-out infinite;
    }

    .progress-step.completed .step-status {
      color: #4caf50;
      font-weight: 600;
    }

    @keyframes pulse-text {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .progress-timeline {
      position: relative;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-timeline-fill {
      height: 100%;
      background: linear-gradient(90deg, #2196f3 0%, #4caf50 100%);
      transition: width 0.5s ease;
      border-radius: 2px;
    }

    .chat-message {
      margin-bottom: 20px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .agent-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-right: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .avatar-analyst { background: linear-gradient(195deg, #42424a 0%, #191919 100%); }
    .avatar-risk { background: linear-gradient(195deg, #EC407A 0%, #D81B60 100%); }
    .avatar-relationship { background: linear-gradient(195deg, #42A5F5 0%, #1E88E5 100%); }
    .avatar-cro { background: linear-gradient(195deg, #66BB6A 0%, #43A047 100%); }
    .avatar-fraud { background: linear-gradient(195deg, #EF5350 0%, #E53935 100%); }
    .avatar-compliance { background: linear-gradient(195deg, #AB47BC 0%, #8E24AA 100%); }

    .agent-info {
      flex: 1;
    }

    .agent-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
    }

    .message-time {
      font-size: 11px;
      color: #999;
      margin-left: 10px;
    }

    .message-content {
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      margin-left: 52px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: relative;
    }

    .message-content::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 15px;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 8px 8px 0;
      border-color: transparent white transparent transparent;
    }

    .message-text {
      color: #444;
      line-height: 1.6;
      white-space: normal;
    }

    /* Markdown Styling */
    .message-text h1,
    .message-text h2,
    .message-text h3,
    .message-text h4,
    .message-text h5,
    .message-text h6 {
      font-weight: 600;
      margin-top: 1.5em;
      margin-bottom: 0.75em;
      line-height: 1.3;
      color: #2c3e50;
    }

    .message-text h1 { font-size: 1.8em; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.3em; }
    .message-text h2 { font-size: 1.5em; border-bottom: 1px solid #e8e8e8; padding-bottom: 0.3em; }
    .message-text h3 { font-size: 1.3em; }
    .message-text h4 { font-size: 1.1em; }
    .message-text h5 { font-size: 1em; }
    .message-text h6 { font-size: 0.9em; color: #666; }

    .message-text h1:first-child,
    .message-text h2:first-child,
    .message-text h3:first-child {
      margin-top: 0;
    }

    .message-text strong,
    .message-text b {
      font-weight: 600;
      color: #2c3e50;
    }

    .message-text em,
    .message-text i {
      font-style: italic;
      color: #555;
    }

    .message-text ul,
    .message-text ol {
      margin: 1em 0;
      padding-left: 2em;
    }

    .message-text li {
      margin: 0.5em 0;
      line-height: 1.6;
    }

    .message-text ul li {
      list-style-type: disc;
    }

    .message-text ol li {
      list-style-type: decimal;
    }

    .message-text ul ul,
    .message-text ol ul {
      list-style-type: circle;
    }

    .message-text code {
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 3px;
      padding: 2px 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      color: #d63384;
    }

    .message-text pre {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px 16px;
      overflow-x: auto;
      margin: 1em 0;
    }

    .message-text pre code {
      background: none;
      border: none;
      padding: 0;
      color: #333;
    }

    .message-text blockquote {
      border-left: 4px solid #2196f3;
      background: #f8f9fa;
      margin: 1em 0;
      padding: 0.5em 1em;
      color: #555;
      font-style: italic;
    }

    .message-text a {
      color: #2196f3;
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: all 0.2s ease;
    }

    .message-text a:hover {
      border-bottom-color: #2196f3;
    }

    .message-text hr {
      border: none;
      border-top: 2px solid #e0e0e0;
      margin: 2em 0;
    }

    .message-text table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
      font-size: 0.95em;
    }

    .message-text table th,
    .message-text table td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
    }

    .message-text table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }

    .message-text table tr:nth-child(even) {
      background: #fafafa;
    }

    .message-text p {
      margin: 0.75em 0;
    }

    .message-text p:first-child {
      margin-top: 0;
    }

    .message-text p:last-child {
      margin-bottom: 0;
    }

    .thinking-indicator {
      display: inline-flex;
      align-items: center;
      font-style: italic;
      color: #999;
      margin-left: 52px;
      padding: 10px 15px;
    }

    .thinking-dots {
      display: inline-flex;
      margin-left: 8px;
    }

    .thinking-dots span {
      width: 6px;
      height: 6px;
      background: #999;
      border-radius: 50%;
      margin: 0 2px;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
    .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .decision-panel {
      background: linear-gradient(195deg, #66BB6A 0%, #43A047 100%);
      color: white;
      padding: 1.25rem;
      border-radius: 0.75rem;
      margin: 1.25rem 0;
      margin-left: 52px;
    }

    .decision-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }

    .decision-title::before {
      content: 'âœ…';
      font-size: 20px;
      margin-right: 10px;
    }

    .decision-details {
      background: rgba(255,255,255,0.2);
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
    }

    /* Team Members Panel */
    .team-members {
      background: white;
      padding: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .team-members-header {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .member-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .member-card {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 10px;
      display: flex;
      align-items: center;
    }

    .member-status {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state h3 {
      color: #666;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    /* Action buttons */
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-action {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(195deg, #EC407A 0%, #D81B60 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(233, 30, 99, 0.4);
    }

    /* Team Configuration Panel */
    .team-config-panel {
      padding: 30px;
      overflow-y: auto;
      max-height: calc(100vh - 300px);
    }

    .team-config-header {
      margin-bottom: 30px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 15px;
    }

    .team-config-header h3 {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin: 0 0 5px 0;
    }

    .team-config-subtitle {
      color: #666;
      font-size: 14px;
      margin: 0;
    }

    .team-members-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 30px;
    }

    .team-member-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .team-member-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .member-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .member-card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .member-card-actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      background: none;
      border: none;
      padding: 6px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
      color: #666;
    }

    .btn-icon:hover {
      background: #f5f5f5;
      color: #333;
    }

    .btn-icon.delete:hover {
      background: #ffebee;
      color: #f44336;
    }

    .member-field-group {
      margin-bottom: 15px;
    }

    .member-field-label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 8px;
      display: block;
    }

    .member-field-input,
    .member-field-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .member-field-input:focus,
    .member-field-textarea:focus {
      outline: none;
      border-color: #e91e63;
      box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
    }

    .member-field-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .team-config-actions {
      display: flex;
      gap: 12px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
      position: sticky;
      bottom: 0;
      background: white;
      padding: 20px 0;
    }

    .team-config-actions .btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .team-config-actions .btn i {
      font-size: 18px;
    }

    .team-config-actions .btn-success {
      background: linear-gradient(195deg, #66BB6A 0%, #43A047 100%);
      color: white;
    }

    .team-config-actions .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    /* Team Presentation Panel */
    .team-presentation-panel {
      padding: 30px;
      overflow-y: auto;
      max-height: calc(100vh - 300px);
    }

    .presentation-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .presentation-header h3 {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin: 0 0 5px 0;
    }

    .presentation-subtitle {
      color: #666;
      font-size: 14px;
      margin: 0;
    }

    .presentation-members-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .presentation-member-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .presentation-member-card:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .presentation-member-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .presentation-member-icon {
      font-size: 40px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(195deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
    }

    .presentation-member-title {
      flex: 1;
    }

    .presentation-member-role {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 0 0 5px 0;
    }

    .presentation-member-type {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
    }

    .presentation-member-section {
      margin-bottom: 15px;
    }

    .presentation-section-label {
      font-size: 11px;
      font-weight: 700;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      display: block;
    }

    .presentation-section-content {
      font-size: 14px;
      color: #555;
      line-height: 1.6;
    }

    .team-config-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .btn-outline-secondary {
      background: white;
      border: 1px solid #e0e0e0;
      color: #666;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-outline-secondary:hover {
      background: #f5f5f5;
      border-color: #999;
      color: #333;
    }

    /* Emoji Picker */
    .emoji-picker-container {
      position: relative;
      display: inline-block;
    }

    .emoji-picker-popup {
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 1000;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      padding: 15px;
      width: 320px;
      max-height: 350px;
      overflow-y: auto;
      display: none;
    }

    .emoji-picker-popup.show {
      display: block;
    }

    .emoji-picker-header {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e0e0e0;
    }

    .emoji-picker-category {
      margin-bottom: 15px;
    }

    .emoji-picker-category-title {
      font-size: 11px;
      font-weight: 600;
      color: #999;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .emoji-picker-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 6px;
    }

    .emoji-picker-item {
      font-size: 24px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      background: #f8f9fa;
    }

    .emoji-picker-item:hover {
      background: #e91e63;
      transform: scale(1.2);
    }

    .emoji-input-wrapper {
      position: relative;
    }

    .emoji-picker-trigger {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .emoji-picker-trigger:hover {
      background: #e0e0e0;
    }

    /* Direct Interaction Panel */
    .direct-interaction-panel {
      padding: 30px;
      background: white;
    }

    .interaction-header {
      margin-bottom: 25px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 15px;
    }

    .interaction-header h3 {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin: 0 0 5px 0;
    }

    .interaction-subtitle {
      color: #666;
      font-size: 14px;
      margin: 0;
    }

    .interaction-form-container {
      max-width: 800px;
    }

    .interaction-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    /* Chat Input Area */
    .chat-input-container {
      border-top: 1px solid #e0e0e0;
      padding: 20px;
      background: white;
      display: none;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .chat-input-wrapper textarea {
      flex: 1;
      resize: none;
      border-radius: 12px;
      padding: 12px 15px;
      border: 1px solid #e0e0e0;
      font-size: 14px;
    }

    .chat-input-wrapper textarea:focus {
      outline: none;
      border-color: #e91e63;
      box-shadow: 0 0 0 2px rgba(233, 30, 99, 0.1);
    }

    .chat-send-btn {
      background: linear-gradient(195deg, #EC407A 0%, #D81B60 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(233, 30, 99, 0.4);
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>

<body class="g-sidenav-show bg-gray-200">
  <!-- Sidebar -->
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 bg-gradient-dark" id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-white opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0" href="/">
        <i class="material-icons-round opacity-10">shield</i>
        <span class="ms-1 font-weight-bold text-white">Email Assistant</span>
      </a>
    </div>
    <hr class="horizontal light mt-0 mb-2">
    <div class="collapse navbar-collapse w-auto max-height-vh-100" id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-white" href="/">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons-round opacity-10">dashboard</i>
            </div>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white" href="/pages/mailbox.html">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons-round opacity-10">email</i>
            </div>
            <span class="nav-link-text ms-1">Mailbox</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white" href="/pages/daily-inbox-digest.html">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons-round opacity-10">summarize</i>
            </div>
            <span class="nav-link-text ms-1">Daily Inbox Digest</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder" style="color: #000; opacity: 0.6;">Virtual Teams</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white" href="/pages/agentic-teams.html?team=fraud">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons-round opacity-10">security</i>
            </div>
            <span class="nav-link-text ms-1">Fraud Unit</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white" href="/pages/agentic-teams.html?team=compliance">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons-round opacity-10">gavel</i>
            </div>
            <span class="nav-link-text ms-1">Compliance</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white" href="/pages/agentic-teams.html?team=investments">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons-round opacity-10">trending_up</i>
            </div>
            <span class="nav-link-text ms-1">Investments</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-white active bg-gradient-primary" href="/pages/agentic-teams.html">
            <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="material-icons-round opacity-10">groups</i>
            </div>
            <span class="nav-link-text ms-1">All Teams</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <h6 class="font-weight-bolder mb-0">AI Bank Teams - Virtual Collaboration</h6>
        </nav>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="dashboard-grid">
      <!-- Left Panel: Email Queue -->
      <div class="email-queue">
        <div class="email-queue-header">
          Email Queue
          <span style="float: right; font-size: 14px; color: #666;">
            <span id="queue-count">0</span> emails
          </span>
        </div>
        <div id="email-queue-container">
          <!-- Email cards will be dynamically inserted here -->
        </div>
      </div>

      <!-- Right Panel: Team Discussion -->
      <div class="discussion-panel">
        <div class="discussion-header">
          <div style="flex: 1;">
            <div class="discussion-title" id="discussion-team">
              Select an email to view team discussion
            </div>
            <div class="discussion-subtitle" id="discussion-subject">
              <!-- Email subject will appear here -->
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="discussion-progress" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <div class="chat-container" id="chat-container">
          <div class="empty-state" id="empty-state" style="display: none;">
            <div class="empty-state-icon">ğŸ’¬</div>
            <h3>No Discussion Selected</h3>
            <p>Select an email from the queue to watch the virtual team discuss and decide</p>
          </div>

          <!-- Direct Interaction Form -->
          <div class="direct-interaction-panel" id="direct-interaction-panel" style="display: none;">
            <div class="interaction-header">
              <div style="flex: 1;">
                <h3 id="interaction-team-title">Ask the Team Directly</h3>
                <p class="interaction-subtitle">Submit a request directly to the team without an email</p>
              </div>
            </div>

            <div class="interaction-form-container">
              <div class="form-group mb-3">
                <label for="direct-query-input" class="form-label">Your Request</label>
                <textarea
                  id="direct-query-input"
                  class="form-control"
                  rows="4"
                  placeholder="e.g., I want a complete analysis for stock Apple"></textarea>
                <small class="form-text text-muted" id="query-hint">
                  For Investment Team: Request stock analysis by company name or ticker symbol
                </small>
              </div>

              <div class="interaction-actions">
                <button class="btn btn-primary" onclick="submitDirectQuery()">
                  <i class="material-icons-round">send</i> Submit to Team
                </button>
                <button class="btn btn-outline-secondary" onclick="clearDirectQuery()">
                  <i class="material-icons-round">clear</i> Clear
                </button>
              </div>
            </div>

            <div id="interaction-result" style="display: none; margin-top: 20px;">
              <div class="alert alert-info">
                <strong>Analysis Started!</strong>
                <span id="interaction-status">The team is working on your request...</span>
              </div>
            </div>
          </div>

          <!-- Team Presentation Panel (Read-only View) -->
          <div class="team-presentation-panel" id="team-presentation-panel" style="display: none;">
            <div class="presentation-header">
              <div style="flex: 1;">
                <h3 id="presentation-team-title">Team Members</h3>
                <p class="presentation-subtitle">Meet the experts who will analyze your emails</p>
              </div>
              <button class="btn btn-primary" onclick="enterEditMode()">
                <i class="material-icons-round">edit</i> Edit Team
              </button>
            </div>

            <div class="presentation-members-grid" id="presentation-members-grid">
              <!-- Team members cards will be loaded here -->
            </div>
          </div>

          <!-- Team Configuration Panel (Edit Mode) -->
          <div class="team-config-panel" id="team-config-panel" style="display: none;">
            <div class="team-config-header">
              <div style="flex: 1;">
                <h3 id="team-config-title">Team Configuration</h3>
                <p class="team-config-subtitle">Customize team members and their prompts</p>
              </div>
              <button class="btn btn-outline-secondary" onclick="exitEditMode()">
                <i class="material-icons-round">arrow_back</i> Back to View
              </button>
            </div>

            <div class="team-members-list" id="team-members-config">
              <!-- Team members will be loaded here -->
            </div>

            <div class="team-config-actions">
              <button class="btn btn-primary" onclick="addTeamMember()">
                <i class="material-icons-round">add</i> Add Team Member
              </button>
              <button class="btn btn-success" onclick="saveTeamConfiguration()">
                <i class="material-icons-round">save</i> Save Configuration
              </button>
            </div>
          </div>
        </div>

        <div class="team-members" id="team-members-panel" style="display: none;">
          <div class="team-members-header">Team Members</div>
          <div class="member-grid" id="team-members-grid">
            <!-- Team member cards will be inserted here -->
          </div>
        </div>

        <!-- Interactive Chat Input -->
        <div class="chat-input-container" id="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea
              id="chat-message-input"
              rows="2"
              placeholder="Ask a follow-up question to the team..."
              onkeypress="handleChatKeypress(event)"></textarea>
            <button class="chat-send-btn" onclick="sendChatMessage()" id="chat-send-btn">
              <i class="material-icons-round">send</i>
              Send
            </button>
          </div>
        </div>
      </div>
    </div>
    </div>
  </main>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/material-dashboard.min.js?v=3.0.0"></script>

  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

  <script>
    const API_BASE_URL = '/api';

    // Sample team definitions
    const TEAMS = {
      'fraud': {
        name: 'Fraud Investigation Unit',
        badge: 'team-fraud',
        members: [
          { role: 'Fraud Detection Specialist', avatar: 'avatar-fraud' },
          { role: 'Forensic Analyst', avatar: 'avatar-analyst' },
          { role: 'Legal Advisor', avatar: 'avatar-compliance' },
          { role: 'Security Director', avatar: 'avatar-cro' }
        ]
      },
      'compliance': {
        name: 'Compliance & Regulatory Affairs',
        badge: 'team-compliance',
        members: [
          { role: 'Compliance Officer', avatar: 'avatar-compliance' },
          { role: 'Legal Counsel', avatar: 'avatar-analyst' },
          { role: 'Auditor', avatar: 'avatar-risk' },
          { role: 'Regulatory Liaison', avatar: 'avatar-cro' }
        ]
      },
      'investments': {
        name: 'Investment Research Team',
        badge: 'team-investments',
        members: [
          { role: 'Research Analyst', avatar: 'avatar-analyst' },
          { role: 'Financial Analyst', avatar: 'avatar-risk' },
          { role: 'Market Strategist', avatar: 'avatar-relationship' },
          { role: 'Chief Investment Officer', avatar: 'avatar-cro' }
        ]
      }
    };

    // Detect team based on email content
    function detectTeam(email) {
      // Only use manually assigned team from database
      // No automatic keyword-based detection
      return email.assigned_team || null;
    }

    // Get selected team from URL parameter
    function getSelectedTeam() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('team') || null; // null means "All Teams"
    }

    // Team Configuration Functions
    let currentTeamConfig = null;

    async function loadTeamConfiguration() {
      const selectedTeam = getSelectedTeam();
      if (!selectedTeam) {
        document.getElementById('team-presentation-panel').style.display = 'none';
        document.getElementById('team-config-panel').style.display = 'none';
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/agentic/teams`);
        const data = await response.json();
        const teamData = data.teams.find(t => t.key === selectedTeam);

        if (teamData) {
          currentTeamConfig = teamData;
          displayTeamPresentation(teamData);
        }
      } catch (error) {
        console.error('Error loading team configuration:', error);
      }
    }

    function displayTeamPresentation(teamData) {
      const presentationPanel = document.getElementById('team-presentation-panel');
      const membersGrid = document.getElementById('presentation-members-grid');
      const titleElement = document.getElementById('presentation-team-title');

      if (titleElement) {
        titleElement.textContent = teamData.name;
      }
      if (membersGrid) {
        membersGrid.innerHTML = '';
        teamData.agents.forEach((agent, index) => {
          const card = createPresentationCard(agent, index);
          membersGrid.appendChild(card);
        });
      }

      presentationPanel.style.display = 'block';
      document.getElementById('team-config-panel').style.display = 'none';
    }

    function createPresentationCard(agent, index) {
      const card = document.createElement('div');
      card.className = 'presentation-member-card';

      const isDecisionMaker = index === 3; // Last agent is decision maker

      card.innerHTML = `
        <div class="presentation-member-header">
          <div class="presentation-member-icon">${agent.icon}</div>
          <div class="presentation-member-title">
            <h4 class="presentation-member-role">${agent.role}</h4>
            <div class="presentation-member-type">${isDecisionMaker ? 'Decision Maker' : 'Team Member'}</div>
          </div>
        </div>

        <div class="presentation-member-section">
          <span class="presentation-section-label">Personality</span>
          <div class="presentation-section-content">${agent.personality || 'Not specified'}</div>
        </div>

        <div class="presentation-member-section">
          <span class="presentation-section-label">Responsibilities</span>
          <div class="presentation-section-content">${agent.responsibilities || 'Not specified'}</div>
        </div>

        <div class="presentation-member-section">
          <span class="presentation-section-label">Communication Style</span>
          <div class="presentation-section-content">${agent.style || 'Not specified'}</div>
        </div>
      `;

      return card;
    }

    function enterEditMode() {
      if (!currentTeamConfig) return;

      document.getElementById('team-presentation-panel').style.display = 'none';
      document.getElementById('team-config-panel').style.display = 'block';
      displayTeamConfiguration(currentTeamConfig);
    }

    function exitEditMode() {
      if (!currentTeamConfig) return;

      document.getElementById('team-config-panel').style.display = 'none';
      document.getElementById('team-presentation-panel').style.display = 'block';
      displayTeamPresentation(currentTeamConfig);
    }

    function displayTeamConfiguration(teamData) {
      const membersContainer = document.getElementById('team-members-config');
      const titleElement = document.getElementById('team-config-title');

      if (titleElement) {
        titleElement.textContent = `${teamData.name} Configuration`;
      }
      if (membersContainer) {
        membersContainer.innerHTML = '';
        teamData.agents.forEach((agent, index) => {
          const card = createMemberCard(agent, index);
          membersContainer.appendChild(card);
        });
      }
    }

    function createMemberCard(agent, index) {
      const card = document.createElement('div');
      card.className = 'team-member-card';
      card.setAttribute('data-index', index);

      card.innerHTML = `
        <div class="member-card-header">
          <div class="member-card-title">
            <span>${agent.icon}</span>
            <span>${agent.role}</span>
          </div>
          <div class="member-card-actions">
            <button class="btn-icon" onclick="toggleMemberEdit(${index})" title="Edit">
              <i class="material-icons-round">edit</i>
            </button>
            <button class="btn-icon delete" onclick="removeMember(${index})" title="Remove">
              <i class="material-icons-round">delete</i>
            </button>
          </div>
        </div>

        <div class="member-field-group">
          <label class="member-field-label">Role</label>
          <input type="text" class="member-field-input" value="${agent.role}"
                 onchange="updateMember(${index}, 'role', this.value)">
        </div>

        <div class="member-field-group">
          <label class="member-field-label">Icon (emoji)</label>
          <div class="emoji-input-wrapper">
            <input type="text" class="member-field-input" id="icon-input-${index}" value="${agent.icon}"
                   onchange="updateMember(${index}, 'icon', this.value)" style="padding-right: 45px;">
            <button type="button" class="emoji-picker-trigger" onclick="toggleEmojiPicker(${index}, event)">ğŸ˜€</button>
          </div>
        </div>

        <div class="member-field-group">
          <label class="member-field-label">Personality</label>
          <textarea class="member-field-textarea"
                    onchange="updateMember(${index}, 'personality', this.value)">${agent.personality || ''}</textarea>
        </div>

        <div class="member-field-group">
          <label class="member-field-label">Responsibilities</label>
          <textarea class="member-field-textarea"
                    onchange="updateMember(${index}, 'responsibilities', this.value)">${agent.responsibilities || ''}</textarea>
        </div>

        <div class="member-field-group">
          <label class="member-field-label">Communication Style</label>
          <textarea class="member-field-textarea"
                    onchange="updateMember(${index}, 'style', this.value)">${agent.style || ''}</textarea>
        </div>
      `;

      return card;
    }

    function updateMember(index, field, value) {
      if (currentTeamConfig && currentTeamConfig.agents[index]) {
        currentTeamConfig.agents[index][field] = value;
        console.log(`Updated ${field} for member ${index}:`, value);
      }
    }

    function removeMember(index) {
      if (!confirm('Are you sure you want to remove this team member?')) {
        return;
      }

      if (currentTeamConfig && currentTeamConfig.agents) {
        currentTeamConfig.agents.splice(index, 1);
        displayTeamConfiguration(currentTeamConfig);
      }
    }

    function addTeamMember() {
      if (!currentTeamConfig) return;

      const newMember = {
        role: 'New Team Member',
        icon: 'ğŸ‘¤',
        personality: '',
        responsibilities: '',
        style: ''
      };

      currentTeamConfig.agents.push(newMember);
      displayTeamConfiguration(currentTeamConfig);
    }

    function toggleMemberEdit(index) {
      // Already editable by default
      alert('All fields are editable. Just click and type!');
    }

    // Emoji Picker
    const emojiCategories = {
      'People': ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ¥²', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤'],
      'Nature': ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ'],
      'Objects': ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³', 'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ'],
      'Business': ['ğŸ’¼', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'âœ‚ï¸', 'ğŸ—‚ï¸', 'ğŸ—ƒï¸', 'ğŸ—„ï¸', 'ğŸ—‘ï¸', 'ğŸ”’', 'ğŸ”“', 'ğŸ”', 'ğŸ”‘', 'ğŸ—ï¸', 'ğŸ”¨', 'ğŸª›', 'âš™ï¸', 'ğŸ—œï¸', 'âš–ï¸', 'ğŸ”—', 'â›“ï¸', 'ğŸ§°', 'ğŸ§²', 'ğŸªœ', 'âš—ï¸', 'ğŸ§ª']
    };

    let currentEmojiPickerIndex = null;

    function toggleEmojiPicker(index, event) {
      event.stopPropagation();

      // Remove any existing picker
      const existingPicker = document.querySelector('.emoji-picker-popup');
      if (existingPicker) {
        existingPicker.remove();
      }

      // If clicking same index, just close
      if (currentEmojiPickerIndex === index) {
        currentEmojiPickerIndex = null;
        return;
      }

      currentEmojiPickerIndex = index;

      // Create picker popup
      const picker = document.createElement('div');
      picker.className = 'emoji-picker-popup show';

      let pickerHTML = '<div class="emoji-picker-header">Select an Emoji</div>';

      for (const [category, emojis] of Object.entries(emojiCategories)) {
        pickerHTML += `
          <div class="emoji-picker-category">
            <div class="emoji-picker-category-title">${category}</div>
            <div class="emoji-picker-grid">
              ${emojis.map(emoji => `<div class="emoji-picker-item" onclick="selectEmoji(${index}, '${emoji}')">${emoji}</div>`).join('')}
            </div>
          </div>
        `;
      }

      picker.innerHTML = pickerHTML;

      // Position picker relative to trigger button
      const trigger = event.target;
      const wrapper = trigger.closest('.emoji-input-wrapper');
      wrapper.style.position = 'relative';
      wrapper.appendChild(picker);
    }

    function selectEmoji(index, emoji) {
      // Update input field
      const input = document.getElementById(`icon-input-${index}`);
      if (input) {
        input.value = emoji;
        updateMember(index, 'icon', emoji);
      }

      // Close picker
      const picker = document.querySelector('.emoji-picker-popup');
      if (picker) {
        picker.remove();
      }
      currentEmojiPickerIndex = null;
    }

    // Close picker when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.emoji-input-wrapper')) {
        const picker = document.querySelector('.emoji-picker-popup');
        if (picker) {
          picker.remove();
          currentEmojiPickerIndex = null;
        }
      }
    });

    async function saveTeamConfiguration() {
      if (!currentTeamConfig) return;

      try {
        const response = await fetch(`${API_BASE_URL}/agentic/teams/${currentTeamConfig.key}/config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            agents: currentTeamConfig.agents
          })
        });

        if (response.ok) {
          alert('Team configuration saved successfully!');
        } else {
          alert('Failed to save configuration. Please try again.');
        }
      } catch (error) {
        console.error('Error saving configuration:', error);
        alert('Error saving configuration. Please try again.');
      }
    }

    // Load emails
    async function loadEmails() {
      try {
        // Get selected team from URL
        const selectedTeam = getSelectedTeam();
        console.log('[loadEmails] Selected team:', selectedTeam);

        // Fetch more emails to ensure we get all assigned ones
        // Backend returns newest first, which includes recently assigned emails
        let apiUrl = `${API_BASE_URL}/emails?limit=200`;
        const response = await fetch(apiUrl);
        const emails = await response.json();
        console.log('[loadEmails] Total emails fetched:', emails.length);

        // Filter emails based on team assignment
        let filteredEmails = emails;
        if (selectedTeam) {
          // Only show emails explicitly assigned to this team
          filteredEmails = emails.filter(email => {
            return email.assigned_team === selectedTeam;
          });
          console.log('[loadEmails] Filtered emails for', selectedTeam, ':', filteredEmails.length);
          if (filteredEmails.length > 0) {
            console.log('[loadEmails] First email:', filteredEmails[0]);
          }
        }

        // Take first 10 emails (or all if less than 10)
        const agenticEmails = filteredEmails.slice(0, 10);
        console.log('[loadEmails] Displaying', agenticEmails.length, 'emails');

        displayEmailQueue(agenticEmails, selectedTeam);
      } catch (error) {
        console.error('Error loading emails:', error);
      }
    }

    // Display email queue
    function displayEmailQueue(emails, selectedTeam) {
      const container = document.getElementById('email-queue-container');
      const queueCountEl = document.getElementById('queue-count');
      if (queueCountEl) {
        queueCountEl.textContent = emails.length;
      }

      // Update header if viewing a specific team
      const queueHeader = document.querySelector('.email-queue-header');
      if (selectedTeam && TEAMS[selectedTeam]) {
        queueHeader.innerHTML = `
          ${TEAMS[selectedTeam].name}
          <span style="float: right; font-size: 14px; color: #666;">
            <span id="queue-count">${emails.length}</span> emails
          </span>
        `;
      }

      if (emails.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: #999;">
            <p>No emails for this team</p>
          </div>
        `;
        return;
      }

      container.innerHTML = emails.map((email, index) => {
        const teamKey = detectTeam(email);
        const team = TEAMS[teamKey];
        // Determine status based on agentic_task_id
        const status = email.agentic_task_id ? 'completed' : 'pending';
        // Check if this is a direct query (no mailpit_id)
        const isDirectQuery = !email.mailpit_id;

        return `
          <div class="email-card ${status}" style="position: relative;">
            <div onclick="viewDiscussion(${email.id}, '${teamKey}', '${email.subject.replace(/'/g, "\\'")}')" style="cursor: pointer; flex: 1;">
              <div class="email-meta">
                <span>
                  <span class="status-indicator status-${status}"></span>
                  ${status.charAt(0).toUpperCase() + status.slice(1)}
                </span>
                <span style="font-size: 11px;">#${email.id}</span>
              </div>
              <div class="email-subject">${email.subject}</div>
              <div style="font-size: 11px; color: #999; margin-bottom: 8px;">
                From: ${email.sender}${isDirectQuery ? ' <span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 6px;">DIRECT</span>' : ''}
              </div>
              <span class="team-badge ${team.badge}">${team.name}</span>
            </div>
            <button onclick="event.stopPropagation(); deleteEmail(${email.id})"
                    style="position: absolute; top: 8px; right: 8px; background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;"
                    onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'"
                    title="Delete this query">Ã—</button>
          </div>
        `;
      }).join('');
    }

    // Delete email/query
    async function deleteEmail(emailId) {
      if (!confirm('Delete this analysis? This cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/emails/${emailId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          console.log('[deleteEmail] Deleted email:', emailId);
          // Reload the email list
          await loadEmails();
          // Clear the discussion panel
          document.getElementById('chat-container').innerHTML = '';
          document.getElementById('team-presentation-panel').style.display = 'block';
          document.getElementById('empty-state').style.display = 'none';
        } else {
          alert('Failed to delete. Please try again.');
        }
      } catch (error) {
        console.error('[deleteEmail] Error:', error);
        alert('Error deleting. Please try again.');
      }
    }

    // View team discussion for selected email
    async function viewDiscussion(emailId, teamKey, subject) {
      console.log('[viewDiscussion] Email:', emailId, 'Team:', teamKey);
      const team = TEAMS[teamKey];

      // Hide team presentation and configuration panels when viewing discussion
      document.getElementById('team-presentation-panel').style.display = 'none';
      document.getElementById('team-config-panel').style.display = 'none';
      document.getElementById('empty-state').style.display = 'none';

      // IMPORTANT: Clear chat container immediately to show we're loading new content
      const chatContainer = document.getElementById('chat-container');
      chatContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Loading analysis...</div>';

      // Update header
      const teamEl = document.getElementById('discussion-team');
      const subjectEl = document.getElementById('discussion-subject');
      if (teamEl) teamEl.textContent = team.name;
      if (subjectEl) subjectEl.textContent = subject;

      // Show team members
      const membersPanel = document.getElementById('team-members-panel');
      const membersGrid = document.getElementById('team-members-grid');
      membersPanel.style.display = 'block';

      membersGrid.innerHTML = team.members.map((member, index) => `
        <div class="member-card">
          <div class="agent-avatar ${member.avatar}"></div>
          <div style="flex: 1;">
            <div style="font-size: 13px; font-weight: 600;">${member.role}</div>
            <div class="member-status">
              ${index === 0 ? 'Speaking' : (index === 1 ? 'Listening' : (index === 2 ? 'Waiting' : 'Analyzing'))}
            </div>
          </div>
        </div>
      `).join('');

      // Check if email already has a task_id - if so, load existing discussion
      try {
        console.log('[viewDiscussion] Fetching email details...');
        const emailResponse = await fetch(`${API_BASE_URL}/emails/${emailId}`);
        const emailData = await emailResponse.json();
        console.log('[viewDiscussion] Email data:', emailData);

        if (emailData.agentic_task_id) {
          console.log('[viewDiscussion] Found existing task:', emailData.agentic_task_id);
          // Load existing discussion
          loadExistingDiscussion(teamKey, emailData.agentic_task_id);
        } else {
          console.log('[viewDiscussion] No existing task, starting new workflow');
          // Start new discussion
          simulateDiscussion(teamKey, emailId);
        }
      } catch (error) {
        console.error('[viewDiscussion] Error:', error);
        // Fallback to starting new discussion
        simulateDiscussion(teamKey, emailId);
      }
    }

    // Load existing discussion from completed task
    async function loadExistingDiscussion(team, taskId) {
      console.log('[loadExistingDiscussion] Loading task:', taskId);
      const chatContainer = document.getElementById('chat-container');

      try {
        const response = await fetch(`${API_BASE_URL}/agentic/tasks/${taskId}`);
        const taskData = await response.json();
        console.log('[loadExistingDiscussion] Task data:', taskData);

        if (taskData.status === 'completed' && taskData.result && taskData.result.discussion) {
          const messages = taskData.result.discussion.messages;
          console.log('[loadExistingDiscussion] Displaying', messages.length, 'messages');
          chatContainer.innerHTML = '';

          // Display all messages
          for (let i = 0; i < messages.length; i++) {
            const message = messages[i];
            const agent = TEAMS[team].members.find(m => m.role === message.role) || TEAMS[team].members[0];

            // Parse Markdown to HTML
            let parsedContent;
            if (typeof marked !== 'undefined') {
              try {
                marked.setOptions({
                  breaks: true,
                  gfm: true,
                  headerIds: false,
                  mangle: false
                });
                parsedContent = marked(message.text);
              } catch (error) {
                console.error('[Markdown] Parse error:', error);
                parsedContent = message.text.replace(/\n/g, '<br>');
              }
            } else {
              parsedContent = message.text.replace(/\n/g, '<br>');
            }

            const messageHTML = `
              <div class="chat-message">
                <div class="message-header">
                  <div class="agent-avatar ${agent.avatar}"></div>
                  <div class="agent-info">
                    <div class="agent-name">${message.role}</div>
                  </div>
                  <span class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="message-content">
                  <div class="message-text">${parsedContent}</div>
                </div>
              </div>
            `;

            chatContainer.insertAdjacentHTML('beforeend', messageHTML);
          }

          // Update progress bar if it exists
          const progressBar = document.getElementById('discussion-progress');
          if (progressBar) {
            progressBar.style.width = '100%';
          }
          const statusText = document.getElementById('status-text');
          if (statusText) {
            statusText.textContent = 'Discussion completed!';
          }
        } else {
          throw new Error('Task not completed or no discussion data');
        }
      } catch (error) {
        console.error('[loadExistingDiscussion] Error:', error);
        chatContainer.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #e53935;">
            <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
            <h3>Error Loading Discussion</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // Run real team discussion using LangGraph backend
    async function simulateDiscussion(team, emailId) {
      console.log('[simulateDiscussion] Starting for email', emailId, 'team', team);
      const chatContainer = document.getElementById('chat-container');
      chatContainer.innerHTML = '';

      // Show loading indicator with progress tracker for investments
      if (team === 'investments') {
        chatContainer.innerHTML = `
          ${createInvestmentProgressTracker()}
          <div style="text-align: center; padding: 40px 20px; color: #999;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤–</div>
            <h3>Assembling Virtual Team...</h3>
            <p>The ${TEAMS[team].name} is analyzing this email</p>
            <div class="thinking-indicator">
              <span id="status-text">Starting workflow...</span>
              <div class="thinking-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        `;
      } else {
        chatContainer.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤–</div>
            <h3>Assembling Virtual Team...</h3>
            <p>The ${TEAMS[team].name} is analyzing this email</p>
            <div class="thinking-indicator">
              <span id="status-text">Starting workflow...</span>
              <div class="thinking-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        `;
      }

      try {
        console.log('[simulateDiscussion] Starting workflow...');
        // Start the workflow (returns immediately with task_id)
        const response = await fetch(`${API_BASE_URL}/agentic/emails/${emailId}/process?team=${team}`, {
          method: 'POST'
        });
        console.log('[simulateDiscussion] Response status:', response.status);

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const startResult = await response.json();
        const taskId = startResult.task_id;
        currentTaskId = taskId;  // Store task ID for chat functionality

        console.log(`Started agentic workflow, task_id: ${taskId}`);

        // Update status (only if element exists)
        const statusTextEl = document.getElementById('status-text');
        if (statusTextEl) {
          statusTextEl.textContent = 'Processing with virtual team...';
        }

        // Enable chat input during analysis
        const chatInputContainer = document.getElementById('chat-input-container');
        if (chatInputContainer) {
          chatInputContainer.style.display = 'block';
        }

        // Real-time update variables
        let displayedMessageCount = 0;

        // Create investment progress tracker for investments team
        const createInvestmentProgressTracker = () => {
          const trackerHTML = `
            <div class="investment-progress-tracker" id="investment-tracker">
              <div class="progress-tracker-title">
                <span>ğŸ“Š</span>
                <span>Investment Analysis Progress</span>
              </div>
              <div class="progress-steps" id="progress-steps">
                <div class="progress-step pending" data-agent="Financial Analyst">
                  <div class="step-icon">ğŸ“Š</div>
                  <div class="step-label">Financial Analysis</div>
                  <div class="step-status">Pending...</div>
                </div>
                <div class="progress-step pending" data-agent="Research Analyst">
                  <div class="step-icon">ğŸ”</div>
                  <div class="step-label">Market Research</div>
                  <div class="step-status">Pending...</div>
                </div>
                <div class="progress-step pending" data-agent="Filings Analyst">
                  <div class="step-icon">ğŸ“‹</div>
                  <div class="step-label">SEC Filings</div>
                  <div class="step-status">Pending...</div>
                </div>
                <div class="progress-step pending" data-agent="Investment Advisor">
                  <div class="step-icon">ğŸ’¼</div>
                  <div class="step-label">Final Recommendation</div>
                  <div class="step-status">Pending...</div>
                </div>
              </div>
              <div class="progress-timeline">
                <div class="progress-timeline-fill" id="investment-timeline-fill" style="width: 0%"></div>
              </div>
            </div>
          `;
          return trackerHTML;
        };

        // Update investment progress tracker
        const updateInvestmentProgress = (role) => {
          const tracker = document.getElementById('investment-tracker');
          if (!tracker) return;

          const steps = tracker.querySelectorAll('.progress-step');
          const agentRoles = ['Financial Analyst', 'Research Analyst', 'Filings Analyst', 'Investment Advisor'];

          const currentIndex = agentRoles.indexOf(role);
          if (currentIndex === -1) return;

          // Update steps
          steps.forEach((step, index) => {
            step.classList.remove('active', 'pending', 'completed');

            if (index < currentIndex) {
              step.classList.add('completed');
              step.querySelector('.step-status').textContent = 'âœ“ Complete';
            } else if (index === currentIndex) {
              step.classList.add('active');
              step.querySelector('.step-status').textContent = 'Analyzing...';
            } else {
              step.classList.add('pending');
              step.querySelector('.step-status').textContent = 'Pending...';
            }
          });

          // Update timeline
          const progress = ((currentIndex + 1) / agentRoles.length) * 100;
          const timeline = document.getElementById('investment-timeline-fill');
          if (timeline) {
            timeline.style.width = `${progress}%`;
          }
        };

        const displayMessage = (message, team, isLast = false) => {
          const agent = TEAMS[team].members.find(m => m.role === message.role) || TEAMS[team].members[0];

          // Update investment tracker if this is investments team
          if (team === 'investments' && message.role) {
            updateInvestmentProgress(message.role);
          }

          // Parse Markdown to HTML
          const parsedContent = typeof marked !== 'undefined'
            ? marked.parse(message.text, {
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
              })
            : message.text.replace(/\n/g, '<br>');

          const messageHTML = `
            <div class="chat-message" style="opacity: 0; transform: translateY(10px);">
              <div class="message-header">
                <div class="agent-avatar ${agent.avatar}"></div>
                <div class="agent-info">
                  <div class="agent-name">${message.role}</div>
                </div>
                <span class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</span>
              </div>
              <div class="message-content">
                <div class="message-text">${parsedContent}</div>
              </div>
            </div>
          `;

          chatContainer.insertAdjacentHTML('beforeend', messageHTML);

          // Animate in
          const lastMessage = chatContainer.lastElementChild;
          setTimeout(() => {
            lastMessage.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            lastMessage.style.opacity = '1';
            lastMessage.style.transform = 'translateY(0)';
          }, 50);

          chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Register handler with global SSE connection
        const sseHandler = (data) => {
          try {
            console.log('[Task SSE] Received event for task:', taskId, data.type);

            // Handle agentic_message events for this task
            if (data.type === 'agentic_message') {
              const message = data.data?.message || data.message;

              // Clear loading state on first message (but preserve tracker for investments)
              if (displayedMessageCount === 0) {
                if (team === 'investments') {
                  // Remove only the loading indicator, keep the progress tracker
                  const loadingDiv = chatContainer.querySelector('.thinking-indicator')?.closest('div[style*="text-align: center"]');
                  if (loadingDiv) {
                    loadingDiv.remove();
                  }
                } else {
                  chatContainer.innerHTML = '';
                }
              }

              // Display message (including thinking messages)
              displayMessage(message, team);

              // Only count non-thinking messages for progress
              if (!message.is_thinking && !message.is_progress) {
                displayedMessageCount++;
              }

              // Update progress (only if elements still exist)
              const totalExpected = TEAMS[team].members.length;
              const progress = (displayedMessageCount / totalExpected) * 100;
              const progressEl = document.getElementById('discussion-progress');
              if (progressEl) {
                progressEl.style.width = progress + '%';
              }

              // Update status text (only if element still exists)
              const statusEl = document.getElementById('status-text');
              if (statusEl) {
                if (displayedMessageCount < totalExpected - 1) {
                  statusEl.textContent = `Agent ${displayedMessageCount} speaking...`;
                } else {
                  statusEl.textContent = 'Final decision being made...';
                }
              }
            }

            // Handle chat user messages
            if (data.type === 'agentic_chat_user') {
              const message = data.message;
              displayMessage(message, team);
            }

            // Handle chat agent responses
            if (data.type === 'agentic_chat_response') {
              const message = data.message;
              displayMessage(message, team);
            }

            // Handle agentic_complete events for this task
            if (data.type === 'agentic_complete') {
              console.log('[Task SSE] Workflow completed');
              const progressEl = document.getElementById('discussion-progress');
              if (progressEl) {
                progressEl.style.width = '100%';
              }
              const statusEl = document.getElementById('status-text');
              if (statusEl) {
                statusEl.textContent = 'Discussion completed!';
              }

              // Show chat input after completion for follow-up questions
              const chatInputContainer = document.getElementById('chat-input-container');
              if (chatInputContainer) {
                chatInputContainer.style.display = 'block';
              }

              // Unregister handler
              unregisterTaskHandler(taskId);
            }
          } catch (parseError) {
            console.error('[Task SSE] Error handling event:', parseError);
          }
        };

        // Register handler BEFORE starting workflow
        if (typeof registerTaskHandler === 'function') {
          registerTaskHandler(taskId, sseHandler);
          console.log('[Task SSE] Handler registered for', taskId);
        } else {
          console.warn('[Task SSE] Global SSE not available, will use polling fallback');
          // Start polling as fallback
          setTimeout(poll, 1000);
        }

        // Polling function as fallback
        let pollCount = 0;
        const maxPolls = 180; // 180 * 1 second = 3 minutes max
        const pollInterval = 1000; // 1 second

        const poll = async () => {
          // Skip polling if global SSE is handling events
          if (typeof registerTaskHandler === 'function' && messageHandlers[taskId]) {
            console.log('[Poll] Skipping poll, Global SSE is handling events');
            return;
          }

          try {
            const statusResponse = await fetch(`${API_BASE_URL}/agentic/tasks/${taskId}`);
            if (!statusResponse.ok) {
              throw new Error(`Status check failed: ${statusResponse.status}`);
            }

            const status = await statusResponse.json();
            console.log(`[Poll] Task status: ${status.status}`, status);

            // Display any new messages as they arrive
            if (status.result && status.result.discussion && status.result.discussion.messages) {
              const messages = status.result.discussion.messages;
              const totalExpected = TEAMS[team].members.length; // 4 agents + 1 decision = 5 messages expected

              // Display new messages
              for (let i = displayedMessageCount; i < messages.length; i++) {
                if (i === 0) {
                  // Clear loading state on first message (but preserve tracker for investments)
                  if (team === 'investments') {
                    const loadingDiv = chatContainer.querySelector('.thinking-indicator')?.closest('div[style*="text-align: center"]');
                    if (loadingDiv) {
                      loadingDiv.remove();
                    }
                  } else {
                    chatContainer.innerHTML = '';
                  }
                }

                displayMessage(messages[i], team, i === messages.length - 1);
                displayedMessageCount++;

                // Update progress (only if element still exists)
                const progress = (displayedMessageCount / totalExpected) * 100;
                const progressEl = document.getElementById('discussion-progress');
                if (progressEl) {
                  progressEl.style.width = progress + '%';
                }

                // Update status text (only if element still exists)
                const statusEl = document.getElementById('status-text');
                if (statusEl) {
                  if (displayedMessageCount < totalExpected - 1) {
                    statusEl.textContent = `Agent ${displayedMessageCount + 1} of ${totalExpected} speaking...`;
                  } else {
                    statusEl.textContent = 'Final decision being made...';
                  }
                }
              }
            }

            if (status.status === 'completed') {
              // Display decision panel if exists
              const result = status.result;
              if (result.discussion.decision && result.discussion.messages) {
                const messages = result.discussion.messages;
                const lastMessage = messages[messages.length - 1];

                if (!lastMessage.is_decision) {
                  const decisionHTML = `
                    <div class="decision-panel" style="opacity: 0; transform: translateY(10px);">
                      <div class="decision-title">Final Decision Reached</div>
                      <div class="decision-details">
                        <strong>${result.discussion.decision.decision_maker}:</strong>
                        <div style="margin-top: 10px; white-space: pre-wrap;">${result.discussion.decision.decision_text}</div>
                      </div>
                    </div>
                  `;
                  chatContainer.insertAdjacentHTML('beforeend', decisionHTML);

                  // Animate in
                  const panel = chatContainer.lastElementChild;
                  setTimeout(() => {
                    panel.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                    panel.style.opacity = '1';
                    panel.style.transform = 'translateY(0)';
                  }, 50);

                  chatContainer.scrollTop = chatContainer.scrollHeight;
                }
              }

              const progressEl = document.getElementById('discussion-progress');
              if (progressEl) {
                progressEl.style.width = '100%';
              }
              const statusEl = document.getElementById('status-text');
              if (statusEl) {
                statusEl.textContent = 'Discussion completed!';
              }

            } else if (status.status === 'failed') {
              throw new Error(status.error || 'Workflow failed');

            } else if (status.status === 'processing') {
              // Continue polling
              pollCount++;

              if (pollCount < maxPolls) {
                setTimeout(poll, pollInterval);
              } else {
                throw new Error('Workflow timeout - taking too long');
              }

            } else if (status.status === 'pending') {
              // Still pending
              if (displayedMessageCount === 0) {
                const statusEl = document.getElementById('status-text');
                if (statusEl) {
                  statusEl.textContent = 'Assembling virtual team...';
                }
              }
              pollCount++;

              if (pollCount < maxPolls) {
                setTimeout(poll, pollInterval);
              } else {
                throw new Error('Workflow timeout - never started');
              }
            }

          } catch (pollError) {
            console.error('[Poll] Polling error:', pollError);
            chatContainer.innerHTML = `
              <div style="text-align: center; padding: 60px 20px; color: #e53935;">
                <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                <h3>Error During Processing</h3>
                <p>${pollError.message}</p>
              </div>
            `;
          }
        };

        // Polling will only start if explicitly triggered (no global SSE available)

      } catch (error) {
        console.error('Error starting team discussion:', error);
        chatContainer.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #e53935;">
            <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
            <h3>Error Running Team Discussion</h3>
            <p>${error.message}</p>
            <p style="font-size: 12px; margin-top: 20px;">Make sure the backend is fully loaded and Ollama is running</p>
          </div>
        `;
      }
    }

    // Highlight active team in sidebar
    function highlightActiveTeam() {
      const selectedTeam = getSelectedTeam();

      // Remove all active classes
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active', 'bg-gradient-primary');
      });

      // Add active class to the selected team link
      if (selectedTeam) {
        const activeLink = document.querySelector(`a[href*="team=${selectedTeam}"]`);
        if (activeLink) {
          activeLink.classList.add('active', 'bg-gradient-primary');
        }
      } else {
        // "All Teams" is active
        const allTeamsLink = document.querySelector('a[href="/pages/agentic-teams.html"]:not([href*="team="])');
        if (allTeamsLink) {
          allTeamsLink.classList.add('active', 'bg-gradient-primary');
        }
      }
    }

    // ============================================
    // Direct Interaction & Chat Functions
    // ============================================

    let currentTaskId = null;
    let currentEmailId = null;

    async function submitDirectQuery() {
      const query = document.getElementById('direct-query-input').value.trim();
      const selectedTeam = getSelectedTeam();

      if (!query) {
        alert('Please enter a request');
        return;
      }

      if (!selectedTeam) {
        alert('Please select a team first');
        return;
      }

      try {
        // Show loading state
        const resultEl = document.getElementById('interaction-result');
        if (resultEl) {
          resultEl.style.display = 'block';
        }
        const statusEl = document.getElementById('interaction-status');
        if (statusEl) {
          statusEl.textContent = 'Starting analysis...';
        }

        // Call API to create direct query task
        const response = await fetch(`${API_BASE_URL}/agentic/direct-query`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            team: selectedTeam,
            query: query
          })
        });

        if (!response.ok) {
          throw new Error('Failed to submit query');
        }

        const result = await response.json();
        currentTaskId = result.task_id;
        const emailId = result.email_id;
        const taskId = result.task_id;

        console.log('[submitDirectQuery] Task created:', taskId, 'Email:', emailId);

        // Reload email list to show the new direct query
        await loadEmails();

        // Hide the interaction form and show the discussion
        document.getElementById('direct-interaction-panel').style.display = 'none';
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('team-presentation-panel').style.display = 'none';

        // Update header
        const teamEl = document.getElementById('discussion-team');
        const subjectEl = document.getElementById('discussion-subject');
        if (teamEl) teamEl.textContent = TEAMS[selectedTeam]?.name || selectedTeam;
        if (subjectEl) subjectEl.textContent = query;

        // DON'T call simulateDiscussion - it would create a duplicate task!
        // Instead, directly show the UI and register SSE handler
        const chatContainer = document.getElementById('chat-container');

        // Show loading with progress tracker
        if (selectedTeam === 'investments') {
          // Create progress tracker function (copy from simulateDiscussion)
          const createProgressTracker = () => `
            <div class="investment-progress-tracker" id="investment-tracker">
              <div class="progress-tracker-title">
                <span>ğŸ“Š</span>
                <span>Investment Analysis Progress</span>
              </div>
              <div class="progress-steps" id="progress-steps">
                <div class="progress-step pending" data-agent="Financial Analyst">
                  <div class="step-icon">ğŸ“Š</div>
                  <div class="step-label">Financial Analysis</div>
                  <div class="step-status">Pending...</div>
                </div>
                <div class="progress-step pending" data-agent="Research Analyst">
                  <div class="step-icon">ğŸ”</div>
                  <div class="step-label">Market Research</div>
                  <div class="step-status">Pending...</div>
                </div>
                <div class="progress-step pending" data-agent="Filings Analyst">
                  <div class="step-icon">ğŸ“‹</div>
                  <div class="step-label">SEC Filings</div>
                  <div class="step-status">Pending...</div>
                </div>
                <div class="progress-step pending" data-agent="Investment Advisor">
                  <div class="step-icon">ğŸ’¼</div>
                  <div class="step-label">Final Recommendation</div>
                  <div class="step-status">Pending...</div>
                </div>
              </div>
              <div class="progress-timeline">
                <div class="progress-timeline-fill" id="investment-timeline-fill" style="width: 0%"></div>
              </div>
            </div>
          `;

          chatContainer.innerHTML = `
            ${createProgressTracker()}
            <div style="text-align: center; padding: 40px 20px; color: #999;">
              <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤–</div>
              <h3>Assembling Virtual Team...</h3>
              <p>The ${TEAMS[selectedTeam].name} is analyzing this request</p>
              <div class="thinking-indicator">
                <span id="status-text">Analysis in progress...</span>
                <div class="thinking-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          `;
        } else {
          chatContainer.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #999;">
              <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤–</div>
              <h3>Assembling Virtual Team...</h3>
              <p>The ${TEAMS[selectedTeam].name} is analyzing this request</p>
            </div>
          `;
        }

        // Register SSE handler for real-time updates
        let displayedMessageCount = 0;

        const updateInvestmentProgress = (role) => {
          const tracker = document.getElementById('investment-tracker');
          if (!tracker) return;

          const steps = tracker.querySelectorAll('.progress-step');
          const agentRoles = ['Financial Analyst', 'Research Analyst', 'Filings Analyst', 'Investment Advisor'];
          const currentIndex = agentRoles.indexOf(role);
          if (currentIndex === -1) return;

          steps.forEach((step, index) => {
            step.classList.remove('active', 'pending', 'completed');
            if (index < currentIndex) {
              step.classList.add('completed');
              step.querySelector('.step-status').textContent = 'âœ“ Complete';
            } else if (index === currentIndex) {
              step.classList.add('active');
              step.querySelector('.step-status').textContent = 'Analyzing...';
            } else {
              step.classList.add('pending');
              step.querySelector('.step-status').textContent = 'Pending...';
            }
          });

          const progress = ((currentIndex + 1) / agentRoles.length) * 100;
          const timeline = document.getElementById('investment-timeline-fill');
          if (timeline) timeline.style.width = `${progress}%`;
        };

        const displayMessage = (message) => {
          if (selectedTeam === 'investments' && message.role) {
            updateInvestmentProgress(message.role);
          }

          // Remove loading on first message
          if (displayedMessageCount === 0) {
            if (selectedTeam === 'investments') {
              const loadingDiv = chatContainer.querySelector('.thinking-indicator')?.closest('div[style*="text-align: center"]');
              if (loadingDiv) loadingDiv.remove();
            } else {
              chatContainer.innerHTML = '';
            }
          }

          const agent = TEAMS[selectedTeam].members.find(m => m.role === message.role) || TEAMS[selectedTeam].members[0];

          // Parse Markdown to HTML
          let parsedContent;
          if (typeof marked !== 'undefined') {
            try {
              marked.setOptions({
                breaks: true,       // Support GFM line breaks
                gfm: true,          // GitHub Flavored Markdown
                headerIds: false,   // Don't add IDs to headers
                mangle: false       // Don't escape email addresses
              });
              parsedContent = marked(message.text);
              console.log('[Markdown] Parsed successfully');
            } catch (error) {
              console.error('[Markdown] Parse error:', error);
              parsedContent = message.text.replace(/\n/g, '<br>');
            }
          } else {
            console.warn('[Markdown] marked library not loaded');
            parsedContent = message.text.replace(/\n/g, '<br>');
          }

          const messageHTML = `
            <div class="chat-message" style="opacity: 0; transform: translateY(10px);">
              <div class="message-header">
                <div class="agent-avatar ${agent.avatar}"></div>
                <div class="agent-info">
                  <div class="agent-name">${message.role}</div>
                </div>
                <span class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</span>
              </div>
              <div class="message-content">
                <div class="message-text">${parsedContent}</div>
              </div>
            </div>
          `;

          chatContainer.insertAdjacentHTML('beforeend', messageHTML);
          const lastMessage = chatContainer.lastElementChild;
          setTimeout(() => {
            lastMessage.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            lastMessage.style.opacity = '1';
            lastMessage.style.transform = 'translateY(0)';
          }, 50);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const sseHandler = (data) => {
          console.log('[Direct Query SSE] Received event:', data.type);

          if (data.type === 'agentic_message') {
            const message = data.data?.message || data.message;
            displayMessage(message);
            displayedMessageCount++;
          }

          if (data.type === 'agentic_complete') {
            console.log('[Direct Query SSE] Analysis complete');
            const progressEl = document.getElementById('discussion-progress');
            if (progressEl) progressEl.style.width = '100%';
            unregisterTaskHandler(taskId);
          }
        };

        // Register handler with global SSE
        if (typeof registerTaskHandler === 'function') {
          registerTaskHandler(taskId, sseHandler);
          console.log('[Direct Query] SSE handler registered for task:', taskId);
        } else {
          console.warn('[Direct Query] Global SSE not available');
        }

        // Enable chat input after analysis starts
        setTimeout(() => {
          document.getElementById('chat-input-container').style.display = 'block';
        }, 2000);

      } catch (error) {
        console.error('Error submitting query:', error);
        const statusEl = document.getElementById('interaction-status');
        if (statusEl) {
          statusEl.textContent = 'Error: ' + error.message;
        }
      }
    }

    function clearDirectQuery() {
      const inputEl = document.getElementById('direct-query-input');
      if (inputEl) {
        inputEl.value = '';
      }
      const resultEl = document.getElementById('interaction-result');
      if (resultEl) {
        resultEl.style.display = 'none';
      }
    }

    async function monitorDirectQueryTask(taskId) {
      // Use the same email monitoring logic but for direct queries
      const chatContainer = document.getElementById('chat-container');
      chatContainer.innerHTML = '';

      let displayedMessageCount = 0;
      let pollCount = 0;
      const maxPolls = 120;
      const pollInterval = 2000;

      const poll = async () => {
        try {
          const response = await fetch(`${API_BASE_URL}/agentic/task/${taskId}`);
          const status = await response.json();

          // Update progress bar (only if element exists)
          const progress = Math.min((status.messages?.length || 0) * 10, 90);
          const progressEl = document.getElementById('discussion-progress');
          if (progressEl) {
            progressEl.style.width = `${progress}%`;
          }

          // Display new messages
          if (status.messages && status.messages.length > displayedMessageCount) {
            for (let i = displayedMessageCount; i < status.messages.length; i++) {
              const msg = status.messages[i];
              displayMessage(msg, chatContainer);
            }
            displayedMessageCount = status.messages.length;
          }

          if (status.status === 'completed') {
            const progressEl = document.getElementById('discussion-progress');
            if (progressEl) {
              progressEl.style.width = '100%';
            }
          } else if (status.status === 'processing' || status.status === 'pending') {
            pollCount++;
            if (pollCount < maxPolls) {
              setTimeout(poll, pollInterval);
            }
          }

        } catch (error) {
          console.error('Polling error:', error);
        }
      };

      poll();
    }

    async function sendChatMessage() {
      const input = document.getElementById('chat-message-input');
      const message = input.value.trim();

      if (!message) return;

      const selectedTeam = getSelectedTeam();
      if (!selectedTeam) {
        alert('Please select a team first');
        return;
      }

      try {
        // Disable input while sending
        input.disabled = true;
        document.getElementById('chat-send-btn').disabled = true;

        // Clear input
        input.value = '';

        const chatContainer = document.getElementById('chat-container');

        // Check if there's an active task - if so, send chat message to task
        if (currentTaskId) {
          // Show user message immediately in chat
          const userMsgHTML = `
            <div class="chat-message">
              <div class="message-header">
                <div class="agent-avatar" style="background: linear-gradient(195deg, #42424a 0%, #191919 100%);">ğŸ‘¤</div>
                <div class="agent-info">
                  <div class="agent-name">You</div>
                </div>
                <span class="message-time">${new Date().toLocaleTimeString()}</span>
              </div>
              <div class="message-content">
                <div class="message-text">${message}</div>
              </div>
            </div>
          `;
          chatContainer.insertAdjacentHTML('beforeend', userMsgHTML);
          chatContainer.scrollTop = chatContainer.scrollHeight;

          // Send chat message to the active task
          const response = await fetch(`${API_BASE_URL}/agentic/task/${currentTaskId}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
          });

          if (!response.ok) {
            throw new Error('Failed to send chat message');
          }

          const result = await response.json();
          // Agent response will be broadcast via SSE and handled by sseHandler

        } else {
          // No active task - create a new direct query (full team discussion)
          chatContainer.innerHTML += `
            <div class="thinking-indicator" style="margin: 20px 0;">
              <span>ğŸ¤– Starting new team analysis...</span>
              <div class="thinking-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          `;
          chatContainer.scrollTop = chatContainer.scrollHeight;

          const response = await fetch(`${API_BASE_URL}/agentic/direct-query`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              team: selectedTeam,
              query: message
            })
          });

          if (!response.ok) {
            throw new Error('Failed to submit query');
          }

          const result = await response.json();
          currentTaskId = result.task_id;
          const emailId = result.email_id;

          // Reload email list to show the new direct query
          await loadEmails();

          // Update header
          const teamEl = document.getElementById('discussion-team');
          const subjectEl = document.getElementById('discussion-subject');
          if (teamEl) teamEl.textContent = TEAMS[selectedTeam]?.name || selectedTeam;
          if (subjectEl) subjectEl.textContent = message;

          // Start the discussion with real-time SSE streaming
          simulateDiscussion(selectedTeam, emailId);
        }

      } catch (error) {
        console.error('Error sending chat message:', error);
        alert('Failed to send message: ' + error.message);
      } finally {
        // Re-enable input
        input.disabled = false;
        document.getElementById('chat-send-btn').disabled = false;
        input.focus();
      }
    }

    function handleChatKeypress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
      }
    }

    function displayMessage(msg, container) {
      const isDecision = msg.is_decision || false;
      const isProgress = msg.is_progress || false;

      if (isProgress) {
        // Show progress indicator
        const progressDiv = document.createElement('div');
        progressDiv.className = 'thinking-indicator';
        progressDiv.innerHTML = `${msg.icon} ${msg.text}<div class="thinking-dots"><span></span><span></span><span></span></div>`;
        container.appendChild(progressDiv);
        setTimeout(() => progressDiv.remove(), 3000);
        return;
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';

      if (isDecision) {
        messageDiv.innerHTML = `
          <div class="decision-panel">
            <div class="decision-title">${msg.role}</div>
            <div class="decision-details">
              <div class="message-text">${escapeHtml(msg.text)}</div>
            </div>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="message-header">
            <div class="agent-avatar">${msg.icon}</div>
            <div class="agent-info">
              <span class="agent-name">${escapeHtml(msg.role)}</span>
              <span class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
            </div>
          </div>
          <div class="message-content">
            <div class="message-text">${escapeHtml(msg.text)}</div>
          </div>
        `;
      }

      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text ? String(text).replace(/[&<>"']/g, m => map[m]) : '';
    }

    // Show direct interaction panel when team is selected
    function showDirectInteractionIfTeamSelected() {
      const selectedTeam = getSelectedTeam();
      const directPanel = document.getElementById('direct-interaction-panel');
      const emptyState = document.getElementById('empty-state');

      if (selectedTeam && !currentTaskId) {
        // Show direct interaction form
        directPanel.style.display = 'block';
        emptyState.style.display = 'none';

        // Update hint based on team
        const hint = document.getElementById('query-hint');
        if (hint) {
          if (selectedTeam === 'investments') {
            hint.textContent = 'For Investment Team: Request stock analysis by company name or ticker symbol (e.g., "Analyze Apple stock" or "Complete analysis for TSLA")';
          } else if (selectedTeam === 'fraud') {
            hint.textContent = 'For Fraud Team: Report suspicious activities (e.g., "Investigate unusual transaction pattern")';
          } else if (selectedTeam === 'compliance') {
            hint.textContent = 'For Compliance Team: Submit regulatory queries (e.g., "Review FATCA compliance requirements")';
          } else {
            hint.textContent = `Submit your request to the ${TEAMS[selectedTeam]?.name || selectedTeam} team`;
          }
        }
      } else if (!selectedTeam) {
        directPanel.style.display = 'none';
        emptyState.style.display = 'block';
      }
    }

    // ============================================
    // Global SSE Connection (Always Active)
    // ============================================
    let globalEventSource = null;
    let messageHandlers = {};  // Map of task_id -> handler function

    function initGlobalSSE() {
      try {
        console.log('[Global SSE] Connecting to event stream...');
        globalEventSource = new EventSource(`${API_BASE_URL}/events`);

        globalEventSource.onopen = () => {
          console.log('[Global SSE] âœ… Connection established');
        };

        globalEventSource.addEventListener('message', (event) => {
          try {
            const data = JSON.parse(event.data);
            console.log('[Global SSE] Received event:', data.type, data.data?.task_id);

            // Route to registered handler
            const taskId = data.data?.task_id || data.task_id;
            if (taskId && messageHandlers[taskId]) {
              messageHandlers[taskId](data);
            }
          } catch (error) {
            console.error('[Global SSE] Error parsing event:', error);
          }
        });

        globalEventSource.onerror = (error) => {
          console.error('[Global SSE] Connection error, will auto-reconnect...', error);
        };

      } catch (error) {
        console.error('[Global SSE] Failed to initialize:', error);
      }
    }

    function registerTaskHandler(taskId, handler) {
      console.log('[Global SSE] Registering handler for task:', taskId);
      messageHandlers[taskId] = handler;
    }

    function unregisterTaskHandler(taskId) {
      console.log('[Global SSE] Unregistering handler for task:', taskId);
      delete messageHandlers[taskId];
    }

    // Initialize on page load
    highlightActiveTeam();
    loadEmails();
    loadTeamConfiguration();
    showDirectInteractionIfTeamSelected();
    initGlobalSSE();  // Start global SSE connection
  </script>
</body>
</html>
